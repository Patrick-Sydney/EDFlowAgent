import React, { useEffect, useMemo, useRef, useState } from "react";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import { ScrollArea } from "@/components/ui/scroll-area";
import { X, Activity, Droplets, HeartPulse, Waves, Thermometer, ShieldAlert } from "lucide-react";

// ------------------------------------------------------------
// NZ Early Warning Score policy (approx bands – please verify)
// This powers BOTH the input band colors and points shown.
// ------------------------------------------------------------
export type Band = { min?: number; max?: number; pts: 0|1|2|3; label?: string; color: string };
export const NZ_POLICY = {
  rr: [
    { max: 4, pts: 3, color: "bg-rose-600" },
    { min: 5, max: 8, pts: 3, color: "bg-rose-600" },
    { min: 9, max: 11, pts: 1, color: "bg-amber-400" },
    { min: 12, max: 20, pts: 0, color: "bg-emerald-500" },
    { min: 21, max: 24, pts: 2, color: "bg-amber-500" },
    { min: 25, pts: 3, color: "bg-rose-600" },
  ] as Band[],
  spo2_scale1: [
    { min: 96, pts: 0, color: "bg-emerald-500" },
    { min: 94, max: 95, pts: 1, color: "bg-amber-400" },
    { min: 92, max: 93, pts: 2, color: "bg-amber-500" },
    { max: 91, pts: 3, color: "bg-rose-600" },
  ] as Band[],
  sbp: [
    { max: 70, pts: 3, color: "bg-rose-600" },
    { min: 71, max: 80, pts: 3, color: "bg-rose-600" },
    { min: 81, max: 90, pts: 2, color: "bg-amber-500" },
    { min: 91, max: 100, pts: 1, color: "bg-amber-400" },
    { min: 101, max: 199, pts: 0, color: "bg-emerald-500" },
    { min: 200, pts: 3, color: "bg-rose-600" },
  ] as Band[],
  hr: [
    { max: 40, pts: 3, color: "bg-rose-600" },
    { min: 41, max: 50, pts: 2, color: "bg-amber-500" },
    { min: 51, max: 90, pts: 0, color: "bg-emerald-500" },
    { min: 91, max: 110, pts: 1, color: "bg-amber-400" },
    { min: 111, max: 130, pts: 2, color: "bg-amber-500" },
    { min: 131, pts: 3, color: "bg-rose-600" },
  ] as Band[],
  temp: [
    { max: 34, pts: 3, color: "bg-rose-600" },
    { min: 35, max: 36, pts: 1, color: "bg-amber-400" },
    { min: 36.1, max: 38, pts: 0, color: "bg-emerald-500" },
    { min: 38.1, max: 38.9, pts: 1, color: "bg-amber-400" },
    { min: 39, pts: 2, color: "bg-amber-500" },
  ] as Band[],
  acvpu: { A: 0, C: 3, V: 3, P: 3, U: 3 } as Record<string, 0|3>,
};

// ------------------------------------------------------------
// Utilities
// ------------------------------------------------------------
const parseNum = (s?: string | number) => {
  if (s === undefined || s === null) return undefined;
  const n = Number(String(s).replace(/[^0-9.\-]/g, ""));
  return Number.isFinite(n) ? n : undefined;
};

const bandPoints = (value: number | undefined, bands: Band[] | undefined): 0|1|2|3 => {
  if (value === undefined || !bands) return 0;
  for (const b of bands) {
    const okMin = b.min === undefined || value >= b.min;
    const okMax = b.max === undefined || value <= b.max;
    if (okMin && okMax) return b.pts;
  }
  return 0;
};

// Vibrate lightly if supported (gloved finger feedback)
const vibe = (ms = 10) => {
  try { (navigator as any)?.vibrate?.(ms); } catch {}
};

// ------------------------------------------------------------
// Numeric keypad (large targets for touch)
// ------------------------------------------------------------
const Key: React.FC<{ label: string; onPress: () => void; grow?: boolean }>= ({ label, onPress, grow }) => (
  <button
    onClick={() => { vibe(5); onPress(); }}
    className={`h-16 text-2xl font-semibold rounded-xl border bg-background active:scale-[0.98] ${grow? 'col-span-2':''}`}
  >{label}</button>
);

export const NumberPad: React.FC<{ onInput: (ch: string) => void; onBackspace: () => void; onDone: () => void; allowDecimal?: boolean }>= ({ onInput, onBackspace, onDone, allowDecimal }) => (
  <div className="grid grid-cols-3 gap-3 p-3 select-none">
    {['1','2','3','4','5','6','7','8','9'].map(k => <Key key={k} label={k} onPress={()=>onInput(k)}/>) }
    {allowDecimal ? <Key label="," onPress={()=>onInput('.')}/> : <div/>}
    <Key label="0" onPress={()=>onInput('0')}/>
    <Key label="⌫" onPress={onBackspace}/>
    <Key label="Done" onPress={onDone} grow/>
  </div>
);

// ------------------------------------------------------------
// BandedInputTouch – tap a band OR use keypad. Large touch targets.
// ------------------------------------------------------------
interface BandedInputTouchProps {
  icon?: React.ReactNode;
  label: string;
  unit?: string;
  value?: string;
  placeholder?: string;
  bands?: Band[];
  onChange: (val?: string) => void;
  keypadDecimal?: boolean;
  min?: number; max?: number;
}

const ptsBadge = (pts: 0|1|2|3) => (
  <Badge className={pts===0? 'bg-emerald-600' : pts===1? 'bg-amber-500' : pts===2? 'bg-orange-600' : 'bg-rose-600'}>+{pts}</Badge>
);

export const BandedInputTouch: React.FC<BandedInputTouchProps> = ({ icon, label, unit, value, placeholder, bands, onChange, keypadDecimal, min, max }) => {
  const [showPad, setShowPad] = useState(false);
  const points = bandPoints(parseNum(value), bands);
  const safeVal = value ?? '';

  const onTapBand = (b: Band) => {
    // choose mid of band for value; respect unit typical decimals
    const mid = b.min !== undefined && b.max !== undefined ? (b.min + b.max)/2 : (b.min ?? b.max ?? 0);
    const str = keypadDecimal ? mid.toFixed(1) : String(Math.round(mid));
    onChange(str);
  };

  const inputCh = (ch: string) => {
    let s = safeVal + ch;
    // allow only one decimal point
    s = s.replace(/(\..*)\./, '$1');
    onChange(s);
  };
  const backspace = () => onChange(safeVal.slice(0, -1) || undefined);

  const commit = () => setShowPad(false);

  // clamps
  const clampedVal = useMemo(() => {
    const n = parseNum(value);
    if (n === undefined) return undefined;
    if (min !== undefined && n < min) return String(min);
    if (max !== undefined && n > max) return String(max);
    return value;
  }, [value, min, max]);

  useEffect(() => { if (clampedVal !== value) onChange(clampedVal); }, [clampedVal]);

  return (
    <div className="rounded-2xl border p-3 bg-background">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2 text-base font-medium">
          {icon}
          <span>{label}</span>
          {unit && <span className="text-muted-foreground">({unit})</span>}
        </div>
        <div className="flex items-center gap-2">
          {ptsBadge(points)}
          <button className="rounded-xl border px-3 py-2 text-xl min-w-[96px] text-right" onClick={()=>{ setShowPad(true); vibe(10); }}>
            {value ?? <span className="text-muted-foreground">{placeholder ?? '—'}</span>}
          </button>
        </div>
      </div>
      {bands && (
        <div className="mt-3 grid grid-cols-6 gap-2">
          {bands.map((b, i) => (
            <button key={i} onClick={()=>{ onTapBand(b); vibe(5); }} className={`h-12 rounded-xl ${b.color} bg-opacity-80 text-white text-sm font-medium active:scale-[0.98]`}>{b.label ?? ''}</button>
          ))}
        </div>
      )}
      {showPad && (
        <div className="fixed inset-0 z-50 bg-black/30 flex items-end" onClick={()=>setShowPad(false)}>
          <div className="w-full bg-background rounded-t-3xl shadow-xl" onClick={e=>e.stopPropagation()}>
            <div className="flex items-center justify-between px-4 pt-3">
              <div className="text-sm text-muted-foreground">Enter {label}{unit? ` (${unit})`: ''}</div>
              <Button variant="ghost" size="icon" onClick={()=>setShowPad(false)}><X className="h-5 w-5"/></Button>
            </div>
            <NumberPad onInput={inputCh} onBackspace={backspace} onDone={commit} allowDecimal={keypadDecimal} />
          </div>
        </div>
      )}
    </div>
  );
};

// ------------------------------------------------------------
// ACVPU chips (large)
// ------------------------------------------------------------
const Chip: React.FC<{ active?: boolean; onClick?: () => void; children: React.ReactNode }>= ({ active, onClick, children }) => (
  <button onClick={()=>{ onClick?.(); vibe(5); }} className={`h-12 rounded-2xl border px-4 text-lg font-semibold active:scale-[0.98] ${active? 'bg-primary text-primary-foreground' : 'bg-background'}`}>{children}</button>
);

export const ACVPUChips: React.FC<{ value?: 'A'|'C'|'V'|'P'|'U'; onChange: (v: 'A'|'C'|'V'|'P'|'U') => void }>= ({ value, onChange }) => (
  <div className="flex gap-2">
    {(['A','C','V','P','U'] as const).map(k => <Chip key={k} active={value===k} onClick={()=>onChange(k)}>{k}</Chip>)}
  </div>
);

// ------------------------------------------------------------
// Observation Set Modal – full‑screen, finger‑first
// ------------------------------------------------------------
export interface Observation { id?: string; type: 'RR'|'SpO2'|'HR'|'BP'|'Temp'|'ACVPU'|'O2'; value: string; unit?: string; takenAt: string; recordedBy: string; phase?: 'triage'|'obs' }

export interface ObservationSetModalTouchProps {
  open: boolean;
  onOpenChange: (o: boolean) => void;
  patientName: string;
  defaults?: Partial<Record<'RR'|'SpO2'|'HR'|'SBP'|'Temp'|'ACVPU'|'O2', string>>;
  onSave: (observations: Observation[]) => void;
  recorder: string;
  isTriage?: boolean;
}

export default function ObservationSetModalTouch({ open, onOpenChange, patientName, defaults, onSave, recorder, isTriage }: ObservationSetModalTouchProps) {
  const [rr, setRR] = useState<string|undefined>(defaults?.RR);
  const [spo2, setSpO2] = useState<string|undefined>(defaults?.SpO2);
  const [hr, setHR] = useState<string|undefined>(defaults?.HR);
  const [sbp, setSBP] = useState<string|undefined>(defaults?.SBP);
  const [temp, setTemp] = useState<string|undefined>(defaults?.Temp);
  const [acvpu, setACVPU] = useState<'A'|'C'|'V'|'P'|'U'|undefined>(defaults?.ACVPU as any ?? 'A');
  const [o2Device, setO2Device] = useState<string|undefined>(defaults?.O2 ?? 'Room air');
  const [o2Lpm, setO2Lpm] = useState<string|undefined>();
  const [scale2, setScale2] = useState<boolean>(false);

  useEffect(()=>{ if(!open) return; vibe(10); }, [open]);

  const rrPts = bandPoints(parseNum(rr), NZ_POLICY.rr);
  const spo2Pts = bandPoints(parseNum(spo2), scale2? NZ_POLICY.spo2_scale1.map(b=>({...b, min: b.min? b.min-2: undefined, max: b.max? b.max-2: undefined})) as any : NZ_POLICY.spo2_scale1);
  const sbpPts = bandPoints(parseNum(sbp), NZ_POLICY.sbp);
  const hrPts = bandPoints(parseNum(hr), NZ_POLICY.hr);
  const tempPts = bandPoints(parseNum(temp), NZ_POLICY.temp);
  const acvpuPts = (NZ_POLICY.acvpu[acvpu ?? 'A'] ?? 0) as 0|3;
  const total = rrPts + spo2Pts + sbpPts + hrPts + tempPts + (acvpuPts as number);

  const canSave = rr || spo2 || hr || sbp || temp || acvpu;

  const commit = () => {
    const ts = new Date().toISOString();
    const list: Observation[] = [];
    if (rr) list.push({ type:'RR', value: rr, unit:'bpm', takenAt: ts, recordedBy: recorder, phase: isTriage? 'triage':'obs' });
    if (spo2) list.push({ type:'SpO2', value: spo2, unit:'%', takenAt: ts, recordedBy: recorder, phase: isTriage? 'triage':'obs' });
    if (hr) list.push({ type:'HR', value: hr, unit:'bpm', takenAt: ts, recordedBy: recorder, phase: isTriage? 'triage':'obs' });
    if (sbp) list.push({ type:'BP', value: `${sbp}/?`, unit:'mmHg', takenAt: ts, recordedBy: recorder, phase: isTriage? 'triage':'obs' });
    if (temp) list.push({ type:'Temp', value: temp, unit:'°C', takenAt: ts, recordedBy: recorder, phase: isTriage? 'triage':'obs' });
    if (acvpu) list.push({ type:'ACVPU', value: acvpu, takenAt: ts, recordedBy: recorder, phase: isTriage? 'triage':'obs' });
    if (o2Device && o2Device !== 'Room air') list.push({ type:'O2', value: o2Lpm? `${o2Device} ${o2Lpm} L/min` : o2Device, takenAt: ts, recordedBy: recorder, phase: isTriage? 'triage':'obs' });

    onSave(list);
    onOpenChange(false);
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="p-0 max-w-[100vw] w-[100vw] sm:max-w-[420px] sm:rounded-2xl rounded-none h-[100vh] sm:h-auto flex flex-col">
        <DialogHeader className="p-4 pb-2">
          <DialogTitle className="text-xl">Record Observations</DialogTitle>
          <div className="text-sm text-muted-foreground">{patientName}</div>
        </DialogHeader>
        <Separator />

        {/* Live EWS total */}
        <div className="px-4 py-2 flex items-center gap-2">
          <Badge className={total>=7? 'bg-rose-600' : total>=4? 'bg-amber-500' : 'bg-emerald-600'}>EWS {total}</Badge>
          <span className="text-xs text-muted-foreground">Live total (updates as you tap)</span>
        </div>

        <ScrollArea className="flex-1 px-4 pb-32">
          <div className="space-y-3">
            <BandedInputTouch icon={<Waves className="h-5 w-5"/>} label="Respiratory Rate" unit="/min" value={rr} onChange={setRR} bands={NZ_POLICY.rr} />

            <div className="rounded-2xl border p-3 bg-background">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2 text-base font-medium"><Droplets className="h-5 w-5"/>Oxygen / SpO₂</div>
                <div className="flex items-center gap-2">
                  {ptsBadge(spo2Pts)}
                  <button className="rounded-xl border px-3 py-2 text-xl min-w-[96px] text-right" onClick={()=>{ /* open keypad inside child */ }}>
                    {spo2 ?? <span className="text-muted-foreground">%</span>}
                  </button>
                </div>
              </div>
              <div className="mt-3 grid grid-cols-2 gap-2">
                <button onClick={()=>{ setO2Device('Room air'); setO2Lpm(undefined); }} className={`h-12 rounded-xl border ${o2Device==='Room air'? 'bg-primary text-primary-foreground':''}`}>Room air</button>
                <button onClick={()=>{ setO2Device('Nasal prongs'); }} className={`h-12 rounded-xl border ${o2Device==='Nasal prongs'? 'bg-primary text-primary-foreground':''}`}>Nasal prongs</button>
                <button onClick={()=>{ setO2Device('Hudson mask'); }} className={`h-12 rounded-xl border ${o2Device==='Hudson mask'? 'bg-primary text-primary-foreground':''}`}>Hudson mask</button>
                <button onClick={()=>{ setO2Device('NRB mask'); }} className={`h-12 rounded-xl border ${o2Device==='NRB mask'? 'bg-primary text-primary-foreground':''}`}>NRB mask</button>
              </div>
              {o2Device && o2Device!=='Room air' && (
                <div className="mt-3">
                  <BandedInputTouch label="Flow" unit="L/min" value={o2Lpm} onChange={setO2Lpm} keypadDecimal bands={[{min:1,max:4,pts:0,color:'bg-emerald-500',label:'1-4'},{min:5,max:8,pts:0,color:'bg-emerald-500',label:'5-8'},{min:9,max:15,pts:0,color:'bg-emerald-500',label:'9-15'}]} />
                </div>
              )}
              <div className="mt-3 flex items-center gap-2">
                <button onClick={()=>setScale2(v=>!v)} className={`h-10 rounded-xl border px-3 ${scale2? 'bg-primary text-primary-foreground':''}`}>SpO₂ Scale 2</button>
                <span className="text-xs text-muted-foreground">COPD/chronic hypercapnia</span>
              </div>
              <div className="mt-3">
                <BandedInputTouch label="SpO₂" unit="%" value={spo2} onChange={setSpO2} bands={NZ_POLICY.spo2_scale1} />
              </div>
            </div>

            <BandedInputTouch icon={<HeartPulse className="h-5 w-5"/>} label="Heart Rate" unit="bpm" value={hr} onChange={setHR} bands={NZ_POLICY.hr} />

            <div className="rounded-2xl border p-3 bg-background">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2 text-base font-medium"><ShieldAlert className="h-5 w-5"/>Blood Pressure</div>
              </div>
              <div className="mt-3 grid grid-cols-3 gap-2">
                <BandedInputTouch label="SBP" unit="mmHg" value={sbp} onChange={setSBP} bands={NZ_POLICY.sbp} />
                <BandedInputTouch label="DBP" unit="mmHg" value={undefined} onChange={()=>{}} />
                <div className="text-xs text-muted-foreground flex items-center">Scoring uses SBP only</div>
              </div>
            </div>

            <BandedInputTouch icon={<Thermometer className="h-5 w-5"/>} label="Temperature" unit="°C" value={temp} onChange={setTemp} keypadDecimal bands={NZ_POLICY.temp} />

            <div className="rounded-2xl border p-3 bg-background">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2 text-base font-medium"><Activity className="h-5 w-5"/>Level of Consciousness</div>
                <Badge className={acvpuPts? 'bg-rose-600' : 'bg-emerald-600'}>+{acvpuPts}</Badge>
              </div>
              <div className="mt-3"><ACVPUChips value={acvpu} onChange={setACVPU} /></div>
            </div>
          </div>
        </ScrollArea>

        {/* Fixed footer actions */}
        <div className="sticky bottom-0 w-full p-4 border-t bg-background">
          <div className="flex items-center justify-between">
            <div className="text-sm text-muted-foreground">Saving creates individual FHIR Observations and updates EWS.</div>
            <div className="flex gap-2">
              <Button variant="outline" className="h-14 px-6 rounded-2xl text-lg" onClick={()=>onOpenChange(false)}>Cancel</Button>
              <Button disabled={!canSave} className="h-14 px-8 rounded-2xl text-lg" onClick={commit}>Save</Button>
            </div>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}
